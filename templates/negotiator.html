<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>AGENTIC MSME-OS</title>
</head>
<body class="bg-slate-950 text-slate-100 p-6 font-sans">
    <div id="toast" class="fixed top-5 right-5 bg-emerald-600 text-white p-4 rounded-2xl shadow-2xl hidden z-50 animate-bounce border border-emerald-400">
        ðŸ¤– AI Agent: New Invoice Analyzed!
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 mb-10 shadow-2xl">
            <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 uppercase">AGENTIC OS</h1>
            <form action="/upload-all" method="POST" enctype="multipart/form-data" class="flex gap-4">
                <input type="file" name="inventory" class="text-[10px]" required>
                <input type="file" name="suppliers" class="text-[10px]" required>
                <button type="submit" class="bg-indigo-600 px-6 py-2 rounded-xl text-xs font-bold uppercase font-bold">LOAD & RUN</button>
            </form>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="bg-slate-900/50 rounded-[2rem] border border-slate-800 p-6 h-[600px] overflow-y-auto">
                <h2 class="text-xl font-bold mb-6 text-slate-400 uppercase text-xs">Warehouse Status</h2>
                {% for i in inventory %}
                <div class="flex justify-between p-4 mb-3 rounded-2xl border transition-all {% if i.stock < i.min_limit %}bg-red-900/10 border-red-500/40 text-red-300 animate-pulse{% else %}bg-black/40 border-slate-800 text-slate-400{% endif %}">
                    <span>{{ i.item }}</span>
                    <span class="font-black font-mono">{{ i.stock }} / {{ i.min_limit }}</span>
                </div>
                {% endfor %}
            </div>

            <div id="agentic-feed" class="bg-indigo-950/10 rounded-[2rem] border border-indigo-500/20 p-6 overflow-y-auto h-[600px]">
                <h2 class="text-xl font-bold mb-6 text-indigo-400 uppercase text-xs">Procurement Agent Activity</h2>
                {% for n in negotiations %}
                <div class="bg-slate-900 p-6 rounded-3xl border border-slate-800 mb-6 shadow-xl">
                    <div class="flex justify-between items-center mb-4 font-bold">
                        <span class="text-[9px] uppercase px-3 py-1 rounded-full bg-indigo-600 tracking-widest">{{ n.status }}</span>
                        <span class="text-emerald-400 font-bold">Est: â‚¹{{ n.invoice_amount }}</span>
                    </div>

                    {% if n.last_reply %}
                    <div class="bg-indigo-900/30 p-3 rounded-xl mb-4 text-[10px] italic border-l-2 border-emerald-500">
                        <strong class="text-emerald-400">ðŸ¤– AI AGENT ANALYSIS:</strong> {{ n.last_reply }}
                    </div>
                    {% endif %}

                    <textarea id="mail-{{ n.id }}" class="w-full bg-black text-indigo-300 p-4 rounded-xl text-[10px] h-48 mb-4 border border-slate-800 focus:border-indigo-500 outline-none">{{ n.draft }}</textarea>
                    
                    <div class="space-y-4">
                        {% if n.status == 'AWAITING_HUMAN' %}
                        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-2 block">AI Negotiation Input</label>
                            <div class="flex gap-2">
                                <input type="text" id="ins-{{ n.id }}" placeholder="e.g. units to 250" class="flex-1 bg-black border border-slate-700 rounded-lg p-2 text-xs outline-none">
                                <button onclick="editAgent('{{ n.id }}')" class="bg-indigo-600 px-4 py-2 rounded text-[10px] uppercase font-bold">Apply</button>
                            </div>
                        </div>
                        <form action="/send-inquiry/{{ n.id }}" method="POST"><button class="w-full bg-blue-600 py-3 rounded-2xl text-xs font-bold uppercase">EXECUTE INQUIRY</button></form>
                        {% elif n.status == 'INQUIRY_SENT' %}
                        <div class="text-center py-6 animate-pulse text-[10px] italic">Agent analyzing incoming vendor responses...</div>
                        {% elif n.status == 'INVOICE_RECEIVED' %}
                        <form action="{{ url_for('finalize_order', id=n.id) }}" method="POST">
                            <button class="w-full bg-emerald-600 py-4 rounded-2xl text-xs font-black uppercase shadow-xl font-bold">APPROVE & RESTOCK</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        let isTyping = false;
        document.addEventListener('focusin', e => { if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') isTyping = true; });
        document.addEventListener('focusout', e => { if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') isTyping = false; });

        setInterval(() => {
            if (!isTyping) {
                fetch('/').then(r => r.text()).then(h => {
                    const doc = new DOMParser().parseFromString(h, 'text/html');
                    const newFeed = doc.querySelector('#agentic-feed').innerHTML;
                    const oldFeed = document.querySelector('#agentic-feed');
                    if (oldFeed.innerHTML.trim() !== newFeed.trim()) {
                        oldFeed.innerHTML = newFeed;
                        document.getElementById('toast').classList.remove('hidden');
                        setTimeout(() => document.getElementById('toast').classList.add('hidden'), 5000);
                    }
                });
            }
        }, 5000);

        function editAgent(id) {
            let ins = document.getElementById('ins-' + id).value;
            fetch('/edit-agent', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id: id, instruction: ins}) })
            .then(r => r.json()).then(d => { if(d.success) document.getElementById('mail-' + id).value = d.new_draft; });
        }
    </script>
</body>
</html>